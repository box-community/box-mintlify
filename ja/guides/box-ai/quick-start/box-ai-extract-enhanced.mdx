---
description: Learn how to use the Box AI Enhanced Extract Agent to automatically extract data from large, complex documents using the Box Python SDK.
sidebarTitle: Box AI - Complex extraction
title: Structured extraction with the Box AI Enhanced Extract Agent in Python

fullyTranslated: true
---

[Box AI](/ai-dev-zone) exposes intelligent extraction capabilities that enable developers to automatically extract key-value pairs from documents through a single API call. The Enhanced Extract Agent uses advanced reasoning models to transform complex unstructured document content into actionable metadata without manual data entry, streamlining document processing workflows for invoices, forms, contracts, and other business documents.

This quick start demonstrates how to configure the Box Python SDK and use Box AI to extract data from a stock purchase agreement stored in Box.

<Steps>
  <Step title="Boxアプリケーションを作成して構成する">
    任意のBox Platform統合では、最初のステップとして、Boxアプリケーションを作成して構成します。

    1. [Box開発者コンソール](https://app.box.com/developers/console)に移動します。
    2. このクイックスタートでは、アプリケーションの種類として`Client Credentials Grant`を使用してアプリを作成します。
    3. アプリが作成されたら、以下のスコープを有効にします。
       * `Read all files and folders stored in Box`
       * `Write all files and folders stored in Box`
       * `Manage AI`

    Boxアプリケーションの新規作成の詳細については、[最初のアプリケーションの作成](/guides/getting-started/first-application#create-your-first-application)を参照してください。
  </Step>

  <Step title="テストファイルをアップロードする">
    After preparing the template, select a file to test. For this quick start, use this [sample stock purchase agreement](/static/quickstarts/extract/files/enhanced-extract-file.pdf).

    1. テスト用ドキュメントをダウンロードして、Boxアカウントにドラッグアンドドロップします。
    2. ファイルIDを確認するには、Boxでファイルを開いてURLを調べます。パスの最後の部分がファイルIDです。たとえば、次のようなURLがあるとします: `https://app.box.com/file/2064123286902`

       この場合、ファイルIDは`2064123286902`です。
  </Step>

  <Step title="環境を設定する">
    抽出を実行するために、開発環境を設定します。このクイックスタートでは、PythonとBox Python SDKバージョン10を使用します。お使いのマシンにPython 3.11以上がインストールされていることを確認してください。

    1. プロジェクト用に新しいディレクトリを作成し、そのディレクトリに移動します。
    2. 仮想環境を作成します。
       ```bash
       python3 -m venv .venv
       source .venv/bin/activate
       ```
    3. Box Python SDKをインストールします。
       ```bash
       pip install "boxsdk~=10"
       ```
    4. `.env`ファイルから環境変数を読み込むために`python-dotenv`パッケージをインストールします。
       ```bash
       pip install python-dotenv
       ```
    5. プロジェクトディレクトリのルートに`.env`ファイルを作成し、以下の環境変数を追加します。その際、プレースホルダの値を実際のBoxアプリの資格情報と前の手順で確認したIDに置き換えます。
       ```bash
        BOX_DEVELOPER_TOKEN=your_box_developer_token

        BOX_METADATA_TEMPLATE_KEY=your_metadata_template_key
        BOX_FILE_ID=your_box_file_id
       ```

    To get your developer token, go to the Box Developer Console, open your app, and navigate to the **Configuration** tab.

    6. \[**開発者トークンを生成**] をクリックして新しいトークンを作成します。

    <Tip>
      簡略化するために、このクイックスタートでは、有効期間の短い開発者トークンを使用します。実稼働環境では、開発者トークンではなく、お使いのアプリに設定された方法 (クライアント資格情報許可など) で認証する必要があります。
    </Tip>
  </Step>

  <Step title="Create the enhanced-extract.py file">
    開発環境の準備ができました。Box AIを使用してドキュメントからデータを抽出するPythonスクリプトを作成できます。

    1. プロジェクトディレクトリのルートに`enhanced-extract.py`という名前の新しいファイルを作成し、以下のコードを追加します。

       ```python
       import os

       from dotenv import load_dotenv

       from box_sdk_gen import (
           AiAgentReference,
           AiAgentReferenceTypeField,
           AiItemBase,
           BoxClient,
           BoxDeveloperTokenAuth,
           CreateAiExtractStructuredFields,
           CreateAiExtractStructuredFieldsOptionsField
       )

       load_dotenv()

       developer_token = os.getenv("BOX_DEVELOPER_TOKEN")
       file_id = os.getenv("BOX_FILE_ID")

       def get_box_client(token: str) -> BoxClient:
           
           if not developer_token:
               raise ValueError("BOX_DEVELOPER_TOKEN is not set in environment variables.")
           
           auth = BoxDeveloperTokenAuth(token=token)
           client = BoxClient(auth=auth)

           return client

       def main():
           client = get_box_client(token=developer_token)

           me = client.users.get_user_me()
           print(f"My user ID is {me.id}")

       if __name__ == "__main__":
           main()
       ```

       このコードは、環境変数を`.env`ファイルから読み込み、Box SDKクライアントを初期化し、現在のユーザーのIDを出力して、クライアントが正しく動作していることを確認します。

    2. ターミナルで次のコマンドを使用してスクリプトを実行します。

       ```bash
       python enhanced-extract.py
       ```

       Box SDKクライアントが正しく設定されると、コンソールにはユーザーIDが表示されます。次に例を示します。

       ```bash
       My user ID is 123456789
       ```
  </Step>

  <Step title="データを抽出する">
    Box SDKクライアントが動作を開始したら、Box AIを使用してドキュメントからデータを抽出するためのコードを追加できます。

    1. `get_box_client`関数と`main`関数の間に次の関数を追加します。

       ```python
       def extract_metadata(client: BoxClient, file_id: str) -> dict:

           enhanced_extract_config = AiAgentReference(
               id="enhanced_extract_agent",
               type=AiAgentReferenceTypeField.AI_AGENT_ID
           )

           fields=[
               CreateAiExtractStructuredFields(
                   key="parties",
                   display_name="Parties",
                   description="The named parties involved",
                   prompt="A comma separated list of the named parties involved",
                   type="string",
               ),
               CreateAiExtractStructuredFields(
                   key="effectiveDate",
                   display_name="Effective date",
                   description="The effective date of the contract",
                   prompt="The effective date of the contract",
                   type="date",
               ),
               CreateAiExtractStructuredFields(
                   key="purchasePrice",
                   display_name="Purchase price",
                   description="The purchase price stated in the contract",
                   prompt="The purchase price stated in the contract",
                   type="float",
               ),
               CreateAiExtractStructuredFields(
                   key="summary",
                   display_name="Summary",
                   description="A summary of the contract in 50 words or less",
                   prompt="A summary of the contract in 50 words or less including key obligations",
                   type="string",
               ),
               CreateAiExtractStructuredFields(
                   key="recommendation",
                   display_name="Recommendation",
                   description="Should we make this purchase?",
                   prompt="Given the financial details, would you recommend proceeding with the purchase? Answer Yes or No.",
                   type="enum",
                   options=[
                       CreateAiExtractStructuredFieldsOptionsField(key="Yes"),
                       CreateAiExtractStructuredFieldsOptionsField(key="No"),
                   ],
               ),
           ]

           metadata = client.ai.create_ai_extract_structured(
               [ AiItemBase(id=file_id) ],
               fields=fields,
               ai_agent=enhanced_extract_config,
           )
           
           return metadata.to_dict()['answer']

       ```

       This function uses the Box AI `create_ai_extract_structured` method to extract metadata from the specified file. Your BoxClient and the file ID are sent to the function, which returns the extracted metadata as a dictionary.

       <Tip>
         The `fields` parameter defines the specific data points to extract from the document. You can also reference a metadata template key instead to extract fields defined in a Box metadata template.
       </Tip>

    2. `main`関数でメタデータを抽出する関数呼び出しを追加します。新しい`main`関数に次のロジックが含まれていることを確認します。

       ```python
       def main():
           client = get_box_client(token=developer_token)

           me = client.users.get_user_me()
           print(f"My user ID is {me.id}")

           metadata = extract_metadata(client=client, file_id=file_id)

           print(f"\n\nExtracted Metadata: {metadata}")
       ```

       SDKはBox AIへのAPIコールを処理し、抽出されたメタデータを[`AiExtractStructuredResponse`](/reference/resources/ai-extract-structured-response)オブジェクトとして返します。このクイックスタートでは、このコードによって、このオブジェクトがディクショナリに変換され、抽出されたキー/値ペアを含む`answer`フィールドが返されます。

    3. ターミナルで次のコマンドを実行して、抽出されたメタデータをコンソールに出力し、抽出が成功したかどうかを確認します。

       ```bash
       python enhanced-extract.py
       ```

       If the extraction was successful, the console displays your user ID followed by the extracted metadata from the stock purchase agreement.

       ```bash
       My user ID is 123456789

       Extracted Metadata: {'parties': 'Argyle LLP, Suregood Family Trust', 'effectiveDate': '2023-03-31', 'purchasePrice': 231000000, 'summary': 'Argyle LLP agrees to purchase 51% of Erebor Life, Inc. from Suregood Family Trust for $231,000,000. The Seller must operate the business normally until closing, and the Buyer must pay the purchase price. The agreement is effective March 31, 2023.', 'recommendation': 'Yes'}
       ```
  </Step>
</Steps>

## リソース

* [最終的なコード](https://github.com/box-community/box-quickstarts/tree/main/box-ai-enhanced-extract-quickstart)
* [構造化メタデータの抽出のAPIリファレンス](/reference/post-ai-extract-structured)
* [Box Python SDK](https://github.com/box/box-python-sdk/tree/main)
